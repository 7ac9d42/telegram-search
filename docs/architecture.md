# Telegram Search 系统架构文档

## 1. 架构概述

Telegram Search 是一个基于 Node.js 的分布式系统，采用模块化设计。系统主要分为前端、后端服务、CLI 工具和数据库四个独立组件，它们通过定义良好的 API 和数据模型进行交互，共享核心业务逻辑和数据访问层。

```
+-------------+     +-------------+     +-------------+
| Frontend    |<--->| API Server  |---->| Database    |
| (Vue 3)     |     | (Node.js)   |     | (PostgreSQL)|
+-------------+     +-------------+     +-------------+
                          |
                          v
                    +-------------+
                    | Core        |
                    | (Adapters)  |
                    +-------------+
                     |           |
               +-----+           +-----+
               |                       |
        +-------------+         +-------------+
        | Telegram API|         | Embedding   |
        |             |         | API (OpenAI)|
        +-------------+         +-------------+

+-------------+     +-------------+
| CLI         |---->| Database    |
| (Commander) |     | (PostgreSQL)|
+-------------+     +-------------+
       |
       v
+-------------+
| Core        |
| (Adapters)  |
+-------------+
 |           |
 |           |
 v           v
+-------------+     +-------------+
| Telegram API|     | Embedding   |
|             |     | API (OpenAI)|
+-------------+     +-------------+
```

## 2. 项目结构

项目采用 monorepo 结构，使用 pnpm workspace 管理多个独立但共享代码的包，主要包括：

```
telegram-search/
├── packages/
│   ├── frontend/     # 前端 Vue 应用
│   ├── server/       # HTTP API 服务（独立组件）
│   ├── cli/          # 命令行工具（独立组件）
│   ├── db/           # 数据库模型和迁移
│   ├── core/         # 核心业务逻辑和适配器
│   └── common/       # 公共工具和类型
├── config/           # 配置文件
├── docs/             # 文档
└── libs/             # 第三方库定制
```

## 3. 核心组件

### 3.1 前端 (packages/frontend)

前端采用 Vue 3 框架构建，提供用户友好的界面进行搜索和消息管理。

**技术栈**：

- Vue 3 + Composition API
- Vue Router
- Vue i18n
- Tanstack Vue Query
- UnoCSS (原子化 CSS)

**主要功能**：

- 消息搜索界面
- 聊天和消息显示
- 会话管理
- 命令中心
- 设置管理
- 媒体预览

**组件结构**：

- `src/pages/` - 页面组件
- `src/components/` - 可复用组件
- `src/composables/` - 组合式函数
- `src/apis/` - API 客户端
- `src/layouts/` - 布局组件
- `src/languages/` - 国际化文本

### 3.2 后端服务 (packages/server)

后端提供 HTTP API 服务，处理前端请求，连接数据库和 Telegram API。这是一个独立的组件，不依赖于 CLI 工具。

**技术栈**：

- Node.js
- Fastify
- WebSockets
- Server-Sent Events (SSE)

**主要功能**：

- 消息搜索和检索
- 用户认证和会话管理
- 实时通知
- 命令执行（同步、导出等）
- 媒体文件服务

**组件结构**：

- `src/routes/` - API 路由定义
- `src/services/` - 业务服务
- `src/utils/` - 工具函数
- `src/types/` - 类型定义

### 3.3 CLI 工具 (packages/cli)

命令行工具，提供消息采集、同步、导入导出等功能。这是一个独立的组件，不依赖于后端服务，可以单独运行。

**技术栈**：

- Commander.js
- Inquirer

**主要命令**：

- `sync` - 同步会话和文件夹
- `watch` - 监听新消息
- `import` - 导入历史记录
- `export` - 导出消息
- `embed` - 处理向量嵌入
- `search` - 启动搜索服务

**组件结构**：

- `src/commands/` - 命令实现
- `src/middlewares/` - 命令中间件

### 3.4 数据库 (packages/db)

负责数据持久化和查询优化，定义数据模型和提供数据访问接口。被 server 和 CLI 组件共同使用，但不建立它们之间的依赖关系。

**技术栈**：

- PostgreSQL 15+
- pgvector 扩展
- Drizzle ORM

**主要模型**：

- `messages` - 消息数据和向量表示
- `chats` - 会话信息
- `folders` - 文件夹数据

**组件结构**：

- `src/schema/` - 数据库表结构定义
- `src/models/` - 数据访问模型
- `src/migrate/` - 数据库迁移脚本

### 3.5 核心服务 (packages/core)

包含系统核心业务逻辑和适配器，用于与外部服务交互。被 server 和 CLI 组件共同使用，但不建立它们之间的依赖关系。

**主要模块**：

- `adapter/client/` - Telegram 客户端适配器
- `adapter/embedding/` - 向量嵌入适配器
- `services/` - 核心服务实现

**适配器设计**：
核心包使用适配器模式与外部服务交互，包括：

- Telegram API 客户端适配器
- 向量嵌入服务适配器（支持 OpenAI、本地部署模型等）
- 存储适配器

### 3.6 公共库 (packages/common)

包含所有包共享的工具和类型定义。

**主要功能**：

- 日志系统
- 通用工具函数
- 共享类型定义
- 错误处理

## 4. 数据流

### 4.1 CLI 消息采集流程

```
用户 -> CLI(sync/watch) -> Core -> TelegramAdapter -> 数据处理 -> 向量嵌入 -> 数据库存储
```

1. 用户通过 CLI 启动同步或监听命令
2. CLI 使用 Core 中的 TelegramAdapter 连接 Telegram API
3. 获取消息数据并进行处理
4. 通过 EmbeddingService 生成向量表示
5. 将消息和向量保存到数据库

### 4.2 Server 搜索流程

```
用户 -> 前端界面 -> HTTP请求 -> 后端服务 -> 数据库查询 -> 结果排序 -> 返回结果
```

1. 用户在前端输入搜索查询
2. 前端发送 HTTP 请求到后端
3. 后端处理请求参数
4. 转换搜索查询为向量表示（语义搜索）
5. 数据库执行向量相似度查询
6. 后端对结果进行排序和过滤
7. 将结果返回给前端展示

## 5. 技术特点

### 5.1 向量搜索实现

系统使用 OpenAI 的文本嵌入模型将消息内容转换为向量表示，实现语义搜索：

1. 消息文本通过 EmbeddingService 转换为 1536 维向量
2. 使用 PostgreSQL 的 pgvector 扩展存储和检索向量
3. 查询时使用余弦相似度计算相关性
4. 多维过滤支持时间、会话、消息类型等条件

### 5.2 可扩展的适配器设计

系统使用适配器模式实现与外部服务的交互，便于扩展和替换组件：

1. 客户端适配器 - 支持不同的 Telegram 客户端实现
2. 嵌入适配器 - 支持多种文本嵌入服务
3. 存储适配器 - 可扩展到不同的存储后端

### 5.3 组件独立性

系统设计强调组件的独立性和可替换性：

1. CLI 和 Server 是完全独立的组件，可以单独部署和运行
2. 两者共享核心业务逻辑和数据访问层，但不相互依赖
3. 这种设计允许灵活的部署选项，例如只使用 CLI 进行数据采集，或只使用 Server 提供搜索服务

### 5.4 实时通知机制

系统使用 WebSocket 和 SSE 实现实时通知：

1. 消息监听服务通过 WebSocket 推送新消息
2. 命令执行状态通过 SSE 进行实时更新
3. 前端通过事件监听处理实时数据

## 6. 部署架构

系统支持多种部署方式，从单机部署到分布式部署：

### 6.1 开发环境

使用 Docker Compose 运行 PostgreSQL 数据库，其他服务在本地运行：

```
+------------------+     +-------------------+
| Node.js Services |<--->| PostgreSQL(Docker)|
+------------------+     +-------------------+
```

### 6.2 生产环境

建议的生产部署架构，展示了 CLI 和 Server 的独立性：

```
+-------------+     +-------------+     +-------------+
| Frontend    |<--->| API Server  |<--->| Database    |
| (Static/CDN)|     | (Node.js)   |     | (PostgreSQL)|
+-------------+     +-------------+     +-------------+
                                              ^
                                              |
                                        +-------------+
                                        | CLI Worker  |
                                        | (Node.js)   |
                                        +-------------+
```

CLI 和 Server 可以部署在不同的服务器上，只需共享同一个数据库。

## 7. 安全考虑

系统处理用户的 Telegram 访问凭据和消息数据，安全性至关重要：

1. 敏感凭据存储 - API ID、Hash 和会话数据加密存储
2. 媒体文件访问控制 - 验证用户权限
3. 依赖更新 - 定期更新依赖以修复安全漏洞

## 8. 未来架构演进

随着系统发展，计划进行以下架构改进：

1. 多 Agent 框架 - 支持多种 LLM 模型和复杂 Agent 协作
2. 分布式向量处理 - 支持大规模向量计算和检索
3. 实时分析管道 - 支持消息流的实时分析和处理
4. 插件系统 - 支持自定义扩展和集成

## 9. 参考

- [数据库设计文档](./database-design.md)
- [开发指南](./development-guide.md)
- [项目 README](../README.md)
